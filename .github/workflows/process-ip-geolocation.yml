name: Process IP Geolocation

on:
  # TODO: Enable automated schedule after testing is complete
  # schedule:
  #   # Run every 2 hours
  #   - cron: '0 */2 * * *'

  workflow_dispatch:
    # Manual triggering only (for testing and on-demand processing)

jobs:
  process-ip-geolocation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get current date for cache key
        id: date
        run: |
          echo "year=$(date +'%Y')" >> $GITHUB_OUTPUT
          echo "month=$(date +'%m')" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache GeoIP databases
        uses: actions/cache@v4
        id: geoip-cache
        with:
          path: resources/geoip
          key: geoip-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}
          restore-keys: |
            geoip-${{ steps.date.outputs.year }}-
            geoip-

      - name: Report cache status
        run: |
          if [ "${{ steps.geoip-cache.outputs.cache-hit }}" == "true" ]; then
            echo "‚úÖ CACHE HIT - Using cached GeoIP databases (key: geoip-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }})"
            echo "üì¶ Cache location: resources/geoip"
            echo "üïê Cache valid for: 7 days from last use"
          else
            echo "‚ö†Ô∏è CACHE MISS - Need to download GeoIP databases"
            echo "üîç Tried key: geoip-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}"
            echo "üì• Will attempt download from MaxMind or GitHub Release fallback"
          fi

      - name: Verify MaxMind License Key
        env:
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          # Debug: Show first 4 and last 4 characters of the license key
          KEY_FIRST="${MAXMIND_LICENSE_KEY:0:4}"
          KEY_LAST="${MAXMIND_LICENSE_KEY: -4}"
          echo "License key check: ${KEY_FIRST}...${KEY_LAST}"
          echo "Expected: Fwls..._mmk"

          # Verify key is not empty
          if [ -z "$MAXMIND_LICENSE_KEY" ]; then
            echo "ERROR: MAXMIND_LICENSE_KEY is empty!"
            exit 1
          fi
          echo "‚úì License key is set (length: ${#MAXMIND_LICENSE_KEY})"

      - name: Download GeoIP databases from MaxMind
        if: steps.geoip-cache.outputs.cache-hit != 'true'
        id: maxmind-download
        continue-on-error: true
        env:
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          echo "========================================="
          echo "üì• DOWNLOADING FROM MAXMIND"
          echo "========================================="
          echo "üåê Source: MaxMind GeoLite2"
          echo "üìÖ Date: ${{ steps.date.outputs.timestamp }}"
          echo "========================================="

          mkdir -p resources/geoip

          # Download GeoLite2-Country database
          echo ""
          echo "üì¶ Downloading GeoLite2-Country database..."
          if curl -fL -o resources/geoip/GeoLite2-Country.tar.gz \
            "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"; then
            echo "‚úÖ Downloaded GeoLite2-Country ($(du -h resources/geoip/GeoLite2-Country.tar.gz | cut -f1))"
          else
            echo "‚ùå Failed to download GeoLite2-Country"
            exit 1
          fi

          # Download GeoLite2-City database
          echo ""
          echo "üì¶ Downloading GeoLite2-City database..."
          if curl -fL -o resources/geoip/GeoLite2-City.tar.gz \
            "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"; then
            echo "‚úÖ Downloaded GeoLite2-City ($(du -h resources/geoip/GeoLite2-City.tar.gz | cut -f1))"
          else
            echo "‚ùå Failed to download GeoLite2-City"
            exit 1
          fi

          # Extract databases
          echo ""
          echo "üìÇ Extracting databases..."
          tar -xzf resources/geoip/GeoLite2-Country.tar.gz -C resources/geoip --strip-components=1 --wildcards '*/GeoLite2-Country.mmdb'
          tar -xzf resources/geoip/GeoLite2-City.tar.gz -C resources/geoip --strip-components=1 --wildcards '*/GeoLite2-City.mmdb'

          # Clean up
          rm -f resources/geoip/*.tar.gz

          # Report success
          echo ""
          echo "========================================="
          echo "‚úÖ MAXMIND DOWNLOAD SUCCESSFUL"
          echo "========================================="
          ls -lh resources/geoip/
          echo "========================================="

      - name: Upload GeoIP databases to GitHub Release
        if: steps.maxmind-download.outcome == 'success'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo ""
          echo "========================================="
          echo "üì§ UPLOADING TO GITHUB RELEASE"
          echo "========================================="
          echo "üè∑Ô∏è Release tag: geoip-latest"
          echo "üìÖ Updated: ${{ steps.date.outputs.timestamp }}"
          echo "========================================="

          # Create or update release
          gh release create geoip-latest \
            --title "GeoIP Databases (Latest)" \
            --notes "GeoLite2 databases updated on ${{ steps.date.outputs.timestamp }}. Source: MaxMind GeoLite2. Files: GeoLite2-Country.mmdb, GeoLite2-City.mmdb. Auto-updated by GitHub Actions. Use as fallback when MaxMind download fails." \
            resources/geoip/*.mmdb \
            --clobber || \
          gh release upload geoip-latest \
            resources/geoip/*.mmdb \
            --clobber

          echo ""
          echo "‚úÖ Uploaded to GitHub Release (geoip-latest)"
          echo "üîó Fallback URL: https://github.com/${{ github.repository }}/releases/tag/geoip-latest"

      - name: Download GeoIP databases from GitHub Release (fallback)
        if: steps.geoip-cache.outputs.cache-hit != 'true' && steps.maxmind-download.outcome != 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo ""
          echo "========================================="
          echo "üîÑ FALLBACK TO GITHUB RELEASE"
          echo "========================================="
          echo "‚ö†Ô∏è MaxMind download failed - using last known good version"
          echo "üè∑Ô∏è Release tag: geoip-latest"
          echo "========================================="

          mkdir -p resources/geoip

          # Download from GitHub Release
          if gh release download geoip-latest \
            --pattern '*.mmdb' \
            --dir resources/geoip \
            --clobber; then

            echo ""
            echo "‚úÖ Downloaded from GitHub Release"
            ls -lh resources/geoip/

            # Get release info
            RELEASE_DATE=$(gh release view geoip-latest --json publishedAt -q .publishedAt)
            echo ""
            echo "üìÖ Release date: $RELEASE_DATE"
            echo "‚ö†Ô∏è Note: Using cached version from GitHub Release (not latest from MaxMind)"
          else
            echo ""
            echo "‚ùå CRITICAL: Failed to download from GitHub Release"
            echo "‚ùå No GeoIP databases available - workflow will fail"
            exit 1
          fi

      - name: Verify GeoIP databases
        run: |
          echo ""
          echo "========================================="
          echo "üîç VERIFYING GEOIP DATABASES"
          echo "========================================="

          if [ ! -f "resources/geoip/GeoLite2-Country.mmdb" ]; then
            echo "‚ùå ERROR: GeoLite2-Country.mmdb not found!"
            exit 1
          fi

          if [ ! -f "resources/geoip/GeoLite2-City.mmdb" ]; then
            echo "‚ùå ERROR: GeoLite2-City.mmdb not found!"
            exit 1
          fi

          echo "‚úÖ GeoLite2-Country.mmdb ($(du -h resources/geoip/GeoLite2-Country.mmdb | cut -f1))"
          echo "‚úÖ GeoLite2-City.mmdb ($(du -h resources/geoip/GeoLite2-City.mmdb | cut -f1))"
          echo ""
          echo "========================================="
          echo "‚úÖ ALL DATABASES VERIFIED - READY TO PROCESS"
          echo "========================================="
          echo ""

          # Summary report
          if [ "${{ steps.geoip-cache.outputs.cache-hit }}" == "true" ]; then
            echo "üìä DATABASE SOURCE: GitHub Actions Cache (7-day)"
            echo "üîë Cache key: geoip-${{ steps.date.outputs.year }}-${{ steps.date.outputs.month }}"
          elif [ "${{ steps.maxmind-download.outcome }}" == "success" ]; then
            echo "üìä DATABASE SOURCE: MaxMind (Fresh Download)"
            echo "üìÖ Downloaded: ${{ steps.date.outputs.timestamp }}"
            echo "üì§ Uploaded to: GitHub Release (geoip-latest)"
          else
            echo "üìä DATABASE SOURCE: GitHub Release (Fallback)"
            echo "‚ö†Ô∏è MaxMind download failed - using last known good version"
          fi
          echo "========================================="

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Create logs directory
        run: mkdir -p logs

      - name: Verify database credentials
        env:
          SUPABASE_PSQL_DB_HOST: ${{ vars.SUPABASE_PSQL_DB_HOST }}
          SUPABASE_PSQL_DB_NAME: ${{ vars.SUPABASE_PSQL_DB_NAME }}
          SUPABASE_PSQL_DB_USER: ${{ vars.SUPABASE_PSQL_DB_USER }}
        run: |
          echo "Database connection config:"
          echo "  Host: $SUPABASE_PSQL_DB_HOST"
          echo "  Database: $SUPABASE_PSQL_DB_NAME"
          echo "  User: $SUPABASE_PSQL_DB_USER"
          echo "  Password: [hidden]"

      - name: Run IP geolocation processing
        env:
          SUPABASE_PSQL_DB_HOST: ${{ vars.SUPABASE_PSQL_DB_HOST }}
          SUPABASE_PSQL_DB_NAME: ${{ vars.SUPABASE_PSQL_DB_NAME }}
          SUPABASE_PSQL_DB_USER: ${{ vars.SUPABASE_PSQL_DB_USER }}
          SUPABASE_PSQL_DB_PASSWORD: ${{ secrets.SUPABASE_PSQL_DB_PASSWORD }}
        run: |
          echo "Starting IP geolocation processing..."
          python scripts/populate_ip_geolocation.py

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ip-geolocation-logs-${{ github.run_number }}
          path: logs/populate_ip_geolocation.log
          retention-days: 7
